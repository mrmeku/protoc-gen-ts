load("@io_bazel_rules_go//go:def.bzl", "go_binary", "go_library")
load("@aspect_rules_ts//ts:defs.bzl", "ts_project")
load("@aspect_bazel_lib//lib:write_source_files.bzl", "write_source_files")
load("@aspect_rules_jasmine//jasmine:defs.bzl", "jasmine_test")

write_source_files(
    name = "diff",
    files = {
        "maps.ts": "//test/conformance/maps/pb:maps.ts",
    },
)

ts_project(
    name = "test_lib",
    srcs = glob(["**/*.ts"]),
    tsconfig = {
        "compilerOptions": {
            "target": "ES2020",
            "module": "CommonJS",
            "noImplicitAny": True,
        },
    },
    deps = [
        "//:node_modules/@grpc/grpc-js",
        "//:node_modules/@types/google-protobuf",
        "//:node_modules/@types/jasmine",
        "//:node_modules/@types/node",
        "//:node_modules/google-protobuf",
    ],
)

jasmine_test(
    name = "test",
    args = ["**/*.spec.js"],
    data = [
        "maps.bin",
        ":test_lib",
    ],
    tags = ["no-windows-latest"],
)

genrule(
    name = "wire",
    outs = ["maps.bin"],
    cmd = "$(location :maps) $@",
    tools = [":maps"],
)

go_library(
    name = "maps_lib",
    srcs = ["maps.go"],
    importpath = "github.com/thesayyn/protoc-gen-ts/test/conformance/maps",
    visibility = ["//visibility:private"],
    deps = [
        "//test/conformance/maps/pb",
        "@org_golang_google_protobuf//proto",
    ],
)

go_binary(
    name = "maps",
    embed = [":maps_lib"],
    visibility = ["//visibility:public"],
)
